---

- name: "Stage {{ item.name }} Private Key"
  synchronize:
    src: "{{ item.ssh_key_data }}"
    dest: "/tmp/{{ item.ssh_key_data }}"
  with_items: "{{ tower_credential_machines | default([])"
  when: item.name is defined
- name: "Add Tower Machine Credential {{ item.name }}"
  tower_credential:
    name: "{{ item.name }}"
    description: "{{ item.description }}"
    kind: "{{ item.kind }}"
    organization: "{{ item.organisation }}"
    state: present
    ssh_key_data: "/tmp/{{ item.ssh_key_data }}"
    username: "{{ item.username }}"
  with_items: "{{ tower_credential_machines | default([])"
  when: item.name is defined

- name: "Remove {{ item.name }} staging file"
  file:
    path: "/tmp/{{ tower_credential_machine_ssh_key_data }}"
    state: absent
  with_items: "{{ tower_credential_machines | default([])"
  when: item.name is defined
...
